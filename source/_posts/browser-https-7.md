---
title: HTTPS 是如何确保安全的？
date: 2020-06-08 22:17:35
tags:
  - HTTPS
categories:
  - [HTTPS]
excerpt: HTTPS 并不是一个新的协议，而是一个加强版的 HTTP。其原理是在 HTTP 和 TCP 之间建立一个中间层，当 HTTP 和 TCP 通信时并不是像之间那样直接通信，而是经过了一个中间层加密，将加密后的数据包传给 TCP，相应的，TCP 必须将数据包解密，才能传给上面的 HTTP。这个中间层也叫安全层，安全层的核心对应的就是数据的加解密。
---

## HTTPS 协议

https 的出现其实是为了弥补 http 在网络安全这块的不足之处，http 协议的设计目的比较简单，就是为了传输超文本文件，那时候没有太强的加密传输的数据需求，所以 http 一直保持着明文传输的特征，对于报文的完整以及对方身份也没有很强的要求，导致 http 存在以下缺点：

- 通信使用明文(不加密)，内容可能会被窃听；
- 不验证通信方的身份，因此有可能遭遇伪装；
- 无法证明报文的完整性，所以有可能已遭遇篡改；

但是随着一些需求的出现，比如网购、在线转账、账号信息等一些场景的应用，对传输的安全性和完整性有了要求，所以也促使在安全方面做出改进。https 并不是一个作为一个新的协议出现，而是一个加强版的 http。其原理是在 http 和 TCP 之间建立一个中间层，当 http 和 TCP 通信时并不是像之间那样直接通信，而是经过了一个中间层加密，将加密后的数据包传给 TCP，相应的，TCP 必须将数据包解密，才能传给上面的 http。这个中间层也叫安全层，安全层的核心对应的就是数据的加解密。

![thdDZd.png](https://s1.ax1x.com/2020/06/08/thdDZd.png)

把添加了加密及认证机制的 http 称为 https (HTTP Secure)。https 只是 http 通信接口部分用 SSL 和 TLS 协议代替而已。SSL 是独立于 http 协议，所以运行在应用层的其他协议均可配合 SSL 协议使用。

## 对称加密

所谓对称，就是采用这种加密方法的双方使用相同的密钥进行加密和解密。而密钥则是控制加解密过程的算法。举个例子，你和恋人想要发送一段只有你俩人知道的文字，并不想让其他人知道，用对称加密的方式如下：

![thDTnU.png](https://s1.ax1x.com/2020/06/08/thDTnU.png)

使用对称加密，因为双方使用相同密钥，如果一方的密钥被泄露，那么加密的信息就不安全了；并且在数据传输之前，双方必须提前商量好密钥，各自保存下来。但对称加密的加解密速度比较快，适合数据比较长时使用。

## 非对称加密

非对称加密需要使用一对非对称的密钥，一把私有密钥，一个公开密钥。私有密钥仅自己知道，公开密钥可以随意发布，任何人都可以获得。使用公钥加密的消息，只有对应的私钥才能解开；反之使用私钥加密的消息，只有公钥可以解开。因为加密和解密使用的是两个不用的密钥，所以也被称为非对称加密。

非对称加密算法实现信息交换的过程大概是，双方会各自生成一对密钥，并将公钥公开，发送密文的一方使用对方的公开密钥进行加密处理，对方收到被加密的信息后，再使用自己的私有密钥进行解密。

但是非对称加密的缺点也存在：

- 非对称加密的性能相对对称加密来说会慢上几倍甚至几百倍，比较消耗系统资源。正是因为如此，https 将两种加密结合了起来；
- 非对称加密时需要使用到接收方的公匙对消息进行加密，但是公匙不是保密的，任何人都可以拿到，中间人也可以。那么中间人可以做两件事，第一件是中间人可以在客户端与服务器交换公匙的时候，将客户端的公匙替换成自己的。这样服务器拿到的公匙将不是客户端的，而是服务器的。服务器也无法判断公匙来源的正确性。第二件是中间人可以不替换公匙，但是他可以截获客户端发来的消息，然后篡改，然后用服务器的公匙加密再发往服务器，服务器将收到错误的消息。

## 数字签名和数字证书

由于非对称加密无法证明公开密钥本身的真实性，或许在传输过程中已经被攻击者替换了。为了解决这个问题，便引入了认证机构，它是公认的权威机构，这个权威机构给你那颁发一个证书。那么如何去申请呢？

1. 首先，服务器方先准备一对公钥和私钥，私钥自己留着用；公钥和公司或个人信息等被服务器的运营人员拿着向 CA 机构提出公钥的申请；
2. CA 通过线上、线下等多种渠道来验证极客时间所提供信息的真实性，如公司是否存在、企业是否合法、域名是否归属该企业等，在判明提出者的身份后，会对申请信息用它的私钥加密生成数字签名，并把原始信息和数字签名合并生成数字证书；
3. 当客户端请求时，服务器会将数字证书发送给客户端，收到证书后客户端会用 CA 的公钥解密与原始信息对比是否相同，一旦验证通过客户端便确认服务器密钥是值得信赖的；
4. 认证机构的公开密钥为了安全的转给客户端，多数浏览器开发商会事先在内部植入常用认证机构的公开密钥；

## HTTPS 安全通信机制流程

![thfqsA.png](https://s1.ax1x.com/2020/06/08/thfqsA.png)

1. 客户端通过发送 Client Hello 报文开始 SSL 通信。报文中包含客户端支持的 SSL 的指定版本、加密组件列表(所使用的加密算法及密钥长度等)；
2. 服务器可进行 SSL 通信时，会以 Server Hello 报文作为应答。和客户端一样，在报文中包含 SSL 版本以及加密组件。服务器的加密组件内容是从接受到的客户端加密组件内筛选出来的。
3. 之后服务器发送 Certificate 报文。报文中包含公开密钥证书。
4. 最后服务器发送 Server Hello Done 报文通知客户端，最初阶段的 SSL 握手协商部分结束。
5. SSL 第一次握手结束之后，客户端以 Client Key Exchange 报文作为回应。报文中包含通信加密中使用的一种被称为 Pre-master secret 的随机密码串。该报文已用步骤 3 中的公开密钥进行加密。
6. 接着客户端继续发送 Change Cipher Spec 报文。该报文会提示服务器，在此报文之后的通信会采用 Pre-master secret 密钥加密。
7. 客户端发送 Finitshed 报文。该报文包含连接至今全部报文的整体校验值。这次握手协商是否能够成功，要以服务器是否能够正确解密该报文作为判定标准。
8. 服务器发送 Change Ciper Spec 报文。
9. 服务器发送 Finished 报文。
10. 服务器和客户端的 Finished 报文交换完毕之后，SSL 连接就算建立完毕。当然，通信会受到 SSL 的保护。从此处开始进行应用层协议的通信，即发送 HTTP 请求。
11. 应用层协议通信，即发送 HTTP 响应。
12. 最后由客户端断开连接。断开连接时，发送 close_notify 报文。
