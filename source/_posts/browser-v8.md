---
title: V8 如何执行一段 JS 代码？
date: 2020-05-31 18:01:57
tags:
  - V8
  - JS 引擎
categories:
  - [JS 引擎]
excerpt: 作为一名前端工程师，对于 JS 代码肯定不陌生，但是对于 JS 代码是如何运行的？和我们常见的 V8 又有什么关系？不知你是不是也会和我有同样的疑问。为此查阅了一些资料，有了简单的初步了解，下面是总结的一些内容。
---

在了解 V8 是如何执行一段 JS 代码之前，我们先了解一下计算机语言的发展。

## 计算机语言

我们知道计算机语言的种类是非常的多，总的来说可以分为**机器语言、汇编语言**和**高级语言**三大类。

**机器语言**

在计算机发明之初，人们为了去控制计算机完成自己的任务或者项目，只能去编写"0"、"1"这种的二进制数字串去控制电脑，其实就是控制计算机硬件的高低电平或通路开路，这种语言就是机器语言。机器语言比较晦涩难懂，使用时也非常痛苦。而且，不同计算机的运行环境不同，指令操作方式也不尽相同，所以机器语言具有特定性，不同的计算机需要不同的编程。

**汇编语言**

不难看出机器语言作为一种编程语言，灵活性和可阅读性较差，为了改变这种现状，人们对机器语言进行了升级：用一些容易理解和记忆的字母、单词来代替一个特定的指令。通过这种方法人们相对容易阅读已经完成的程序，并且对程序中的 bug 修复和维护都变得更加简单方便，这种语言即第二代计算机语言 --- 汇编语言。

汇编语言虽然有了很大的进步，但它仍然是面向机器的语言，很难从其代码上理解程序设计意图，涉及出来的程序不易被移植。

**高级语言**

汇编语言之后，人们发现了限制程序推广的关键因素是程序的可移植性。所以需要设计一个能够不依赖计算机硬件，能够在不同机器上运行的程序，这样可以免去很多编程的重复过程、提高效率，同时接近于数学语言或人的自然语言，所以人们又设计出了高级语言，来满足人们对于高效简的编程语言的追求。

汇编语言较高级语言而言，特点是能被计算机直接识别和执行，使用它进行编程可以减少占用空间、提高运行速度，并直接对硬件实施控制，尤其是需要实时控制的时候，有着不可替代的重要地位；而高级语言是面向使用者，它的表达能力强、功能多、编程效率高、上手速度快。这两者并不是互斥的，而是有着紧密的联系，在一些程序设计中，如果把两者结合起来使用，可以解决很多特性难题。

**高级语言的工作方式**

用高级编程语言编写的程序需要经过翻译，翻译成机器所能识别的二进制数才能由计算机去执行。翻译的方法有两种，一种是解释（解释型语言），一种是编译（编译型语言）。两种方式只是翻译的时间不同。

1. 编译型语言：程序在执行之前需要一个专门的编译过程，把程序编译成为机器语言的文件，运行时不再需要重新翻译，直接使用编译的结果就行了。程序的执行效率高，依赖编译器，跨平台性差些。如 C、C++等。

2. 解释性语言：程序不需要编译，程序在运行时才翻译成机器语言，每执行一次都要翻译一次，因此效率比较低。

我们日常开发所用的 JavaScript，就是一种高级编程语言，采用的是解释型方式。

说了这么多，你可能会问，这些东西和 V8 有什么关系呢？

其实正是我们因为我们用的 JavaScript 是高级语言，所以需要翻译成机器能够识别的代码才能执行。而 V8 可以看成一个虚构出来的计算机，也称虚拟机，虚拟机通过模拟实际计算机的各种功能来实现代码的执行。所以对于 JavaScript 代码来说，V8 就是它的整个世界，当 V8 执行 JavaScript 代码时，你并不需要担心现实中不同操作系统的差异，也不需要担心不同体系结构计算机的差异，只需要按照虚拟机的规范写好代码就可以了。

**JavaScript**

，所以运行一段 JavaScript 代码需要先经过翻译，JavaScript 引擎就是一个专门用来处理 JavaScript 脚本的虚拟机，能够提供执行 JavaScript 代码的运行环境。日常开发中，我们接触到的各个浏览器的 JS 引擎也不同，比如 苹果公司在 Safari 中用的是 JavaScriptCore 虚拟机，Firefox 使用了 TraceMonkey 虚拟机，而 Chrome 则使用了 V8 虚拟机。

## 什么是 V8

对于 V8 相信大多数开发者都不陌生，V8 是一个由 Google 开发的开源 JavaScript 引擎，目前用在 Chrome 浏览器和 Node.js 中，其核心是执行 JavaScript 代码。那么 V8 有哪些组成部分呢？

V8 是由许多子模块构成的，其中最重要的 4 个模块有：

- Parse：负责将 JavaScript 源码转换为 Abstract Syntax Tree(AST);
- Ignition：interpreter，即解释器，负责将 AST 转换为 Bytecode 字节码，然后解释执行字节码；同时收集 TurboFan 优化编译所需的信息，比如函数参数的类型；
- TurboFun：compiler，即编译器，利用 Ignition 所收集的类型信息，将 Bytecode 字节码转换为优化的汇编代码；
- Orinoco：garbage collector，垃圾回收模块，负责将程序不再需要的内存空间回收；

那么 V8 是怎么执行 JavaScript 代码的呢？简单的说就是，Parse 将 JS 源代码转换为 AST，然后 Ignition 将 AST 转换为字节码，最后 TurboFan 将字节码转换为经过优化的机器码。

如果函数没有调用，则 V8 不会去编译它。
如果函数指被调用 1 次，则 Ignition 将其编译为字节码就直接解释执行了。TurboFan 不会进行优化编译，因为它需要 Ignition 收集函数执行时的类型信息。这就要求函数至少需要执行 1 次，TurboFan 才有可能进行优化编译。
如果函数被多次调用，则它有可能会被识别为热点函数，且 Ignition 收集的类型信息证明可以进行优化编译的化，这时 TurboFan 则会将字节码编译为优化的机器码，以提高代码的执行性能。

首先根据上述概念的理解，我们知道 JavaScript 语言作为一种高级语言，是需要翻译为机器可以识别的机器代码，然后执行。所以其主要的核心流程可以分为**编译**和**执行**两步，首先将 JavaScript 代码转换为机器代码，然后再执行转换后的代码。那么 V8 到底是如何进行翻译的操作的呢？

实际上，V8 并不仅仅采用了解释执行，而是同时混合了编译过程，因为解释执行启动速度快执行速度慢，而编译执行则是启动速度慢，执行速度快，采用混合方式可以结合两者的优点，加速执行时间。

## 代码执行过程

当运行一段代码时，V8 首先接收到的是一段 JS 源代码，但是对它来说不过是一堆字符串而已，所以它会先将字符串结构化生成抽象语法树（AST），同时 V8 还会生成相关的作用域。

有了 AST 和作用域之后，接下来就可以生成字节码了，字节码是介于 AST 和机器代码的中间代码。

生成字节码之后，解释器就登场了，他会按照顺序解释执行字节码，并输出执行结果。在解释执行字节码的过程中如果发现了某一段代码被执行了重复执行多次，那么这段代码将被标记为热点代码，标记为热点代码之后，V8 就会将这段字节码丢给编译器，编译器会在后台将字节码编译为二进制代码，然后再对编译后的二进制代码执行优化操作。

不过，和静态语言不同的是，JavaScript 是一种非常灵活的动态语言，对象的结构和属性是可以在运行时任意修改的，而经过编译器优化的代码只能针对某种固定的结构，一旦在执行的过程中，对象的结构被动态修改了，那么编译器就需要执行反优化操作，经过反优化的代码，下次执行时就会回退到解释器解释执行。

## 一段代码的实际执行流程

我们以一段最简单的 JavaScript 代码为例，如果将这段非常简单的代码提交给 V8 引擎，V8 在处理过程中，中间所产生的结果是怎样的呢？
